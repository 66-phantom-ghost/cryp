<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Crypto-Gate</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #0f0f1a; 
    color: #e0e0ff; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    min-height: 100vh; 
  }
  input, textarea, button { 
    margin: 5px; 
    padding: 10px; 
    width: 300px; 
    font-size: 1rem; 
    border-radius: 5px; 
    border: none; 
  }
  button { 
    cursor: pointer; 
    background: #4b6ef6; 
    color: #fff; 
    font-weight: bold; 
  }
  button:hover { 
    background: #3a5acc; 
  }
  textarea { 
    height: 100px; 
    resize: none; 
  }
  h1 { 
    color: #4b6ef6; 
  }
</style>
</head>
<body>
<h1>Crypto-Gate</h1>

<input id="password" type="password" placeholder="Passwort">
<textarea id="data" placeholder="Zu verschl端sselnder Text"></textarea>
<textarea id="result" placeholder="Ergebnis" readonly></textarea>

<button id="encryptBtn">Verschl端sseln</button>
<button id="decryptBtn">Entschl端sseln</button>

<script>
const SERVER = "https://unwintry-strapping-winford.ngrok-free.dev";

async function getChallenge() {
  try {
    const res = await fetch(`${SERVER}/api/challenge`, { method: 'POST' });
    if (!res.ok) throw new Error('Challenge konnte nicht abgerufen werden');
    const data = await res.json();
    return data.challenge;
  } catch (err) {
    alert("Challenge Fehler: " + err.message);
    throw err;
  }
}

function generateNonce() {
  return Array.from(crypto.getRandomValues(new Uint8Array(16)))
              .map(b => b.toString(16).padStart(2,'0')).join('');
}

async function hmacSha256(msg, key) {
  const cryptoKey = await crypto.subtle.importKey(
    "raw", key, { name: "HMAC", hash: "SHA-256" }, false, ["sign"]
  );
  const sig = await crypto.subtle.sign("HMAC", cryptoKey, new TextEncoder().encode(msg));
  return Array.from(new Uint8Array(sig)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function doCrypto(mode) {
  try {
    const challenge = await getChallenge();
    const password = document.getElementById("password").value;
    const data = document.getElementById("data").value;
    if (!password || !data) { alert("Bitte Passwort und Text eingeben!"); return; }

    const nonce = generateNonce();
    const payloadHash = await hmacSha256(JSON.stringify({challenge, nonce, mode}), new TextEncoder().encode("clientplaceholder"));

    const res = await fetch(`${SERVER}/api/${mode}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ challenge, nonce, password, data, signature: payloadHash })
    });

    if (!res.ok) throw new Error("Serverantwort ung端ltig");
    const json = await res.json();
    document.getElementById("result").value = json.result;
  } catch (err) {
    alert(`${mode.charAt(0).toUpperCase()+mode.slice(1)} Fehler: ${err.message}`);
  }
}

document.getElementById("encryptBtn").onclick = () => doCrypto('encrypt');
document.getElementById("decryptBtn").onclick = () => doCrypto('decrypt');
</script>
</body>
</html>
