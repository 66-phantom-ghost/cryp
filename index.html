<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto-Gate</title>
<style>
:root {
  --bg: #000000;
  --card: #0a0a0a;
  --panel: #1a0a0a;
  --accent-red: #FF073A;
  --accent-red-dark: #C0042D;
  --accent-green: #00FF41;
  --accent-green-dark: #00C834;
  --text: #e5e7eb;
  --muted: #888;
  --border: rgba(255,255,255,0.08);
}

* { box-sizing: border-box; }

body {
  margin:0; min-height:100vh;
  font-family: 'Inter', sans-serif;
  background: radial-gradient(circle at center, #1a0000 0%, #000 80%);
  display:flex; justify-content:center; align-items:center;
  color: var(--text);
}

.wrapper {
  width: 100%; max-width: 460px; padding: 24px;
}

.card {
  background: var(--card);
  border-radius: 16px; padding: 28px;
  box-shadow: 0 0 50px rgba(255,7,58,0.4), 0 10px 20px rgba(0,0,0,.8), inset 0 0 0 1px var(--border);
}

header { text-align:center; margin-bottom: 26px; }
header h1 { margin:0; font-size:1.8rem; font-weight:700; color: var(--accent-red); }
header p { margin:6px 0 0; font-size:.9rem; color: var(--muted); }

label { display:block; font-size:.8rem; color: var(--muted); margin-bottom:6px; }
input, textarea {
  width:100%; background: var(--panel); border:none; border-radius:10px;
  padding:14px; font-size:.95rem; color:var(--text); margin-bottom:16px;
  box-shadow: inset 0 0 0 1px var(--border); outline:none;
}
input:focus, textarea:focus { box-shadow: 0 0 0 2px var(--accent-red), inset 0 0 0 1px var(--accent-red); }
textarea { resize:vertical; min-height:90px; }

.actions { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
button {
  border:none; border-radius:12px; padding:14px; font-weight:700; cursor:pointer;
  font-size:.9rem; transition: transform .15s ease, box-shadow .3s ease, opacity .15s;
}
button:hover { transform:translateY(-2px); opacity:0.95; }

.encrypt {
  background: linear-gradient(135deg,var(--accent-red),var(--accent-red-dark));
  color:white; box-shadow: 0 10px 25px rgba(255,7,58,0.4);
}
.encrypt:hover { box-shadow:0 15px 35px rgba(255,7,58,0.4),0 0 10px var(--accent-red); }

.decrypt {
  background: linear-gradient(135deg,var(--accent-green),var(--accent-green-dark));
  color: var(--card); box-shadow:0 10px 25px rgba(0,255,65,0.4);
}
.decrypt:hover { box-shadow:0 15px 35px rgba(0,255,65,0.4),0 0 10px var(--accent-green); }

.output {
  background: var(--panel); border-radius:12px; padding:14px; font-family: monospace;
  font-size:.85rem; word-break: break-all; box-shadow: inset 0 0 0 1px var(--border);
  color: #00FFFF;
}

.meta { display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-size:.75rem; color:var(--muted); }

.copy {
  background:transparent; border:1px solid var(--accent-green); color: var(--accent-green);
  padding:6px 10px; border-radius:8px; cursor:pointer; transition: background-color 0.2s, box-shadow 0.2s;
}
.copy:hover { background: rgba(0,255,65,0.1); box-shadow:0 0 8px rgba(0,255,65,0.4); }

.reset {
  margin-top:10px; background: #ff3b3b; color:white; border:none; border-radius:8px;
  padding:8px 12px; cursor:pointer; width:100%; font-weight:700;
}
.reset:hover { background:#c70000; }
</style>
</head>
<body>
<div class="wrapper">
  <div class="card">
    <header>
      <h1>Crypto-Gate</h1>
      <p>Private · Minimal · Secure</p>
    </header>

    <label for="password">Passwort</label>
    <input id="password" type="password" placeholder="••••••••">

    <label for="text">Text</label>
    <textarea id="text" placeholder="Klartext oder verschlüsselter Inhalt"></textarea>

    <div class="actions">
      <button class="encrypt" onclick="run('encrypt')">Verschlüsseln</button>
      <button class="decrypt" onclick="run('decrypt')">Entschlüsseln</button>
    </div>

    <div class="output" id="preview">Bereit.</div>
    <div class="meta">
      <span id="info"></span>
      <button class="copy" id="copyBtn" onclick="copy()" style="display:none">Kopieren</button>
    </div>

    <button class="reset" onclick="resetBadClient()">Reset BadClient</button>
  </div>
</div>

<script>
const SERVER_URL = "https://unwintry-strapping-winford.ngrok-free.dev";

let full = "";

async function fetchWithRetry(url, options, retries = 3) {
  for(let i=0;i<retries;i++){
    try{
      const res = await fetch(url, options);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res;
    }catch(e){
      if(i<retries-1) await new Promise(r=>setTimeout(r,Math.pow(2,i)*500));
      else throw e;
    }
  }
}

function shorten(str){
  if(str.length<48) return str;
  return str.slice(0,22)+"…"+str.slice(-22);
}

async function run(mode){
  const pw = document.getElementById('password').value.trim();
  const tx = document.getElementById('text').value.trim();
  const preview = document.getElementById('preview');
  const info = document.getElementById('info');
  const copyBtn = document.getElementById('copyBtn');

  if(!pw||!tx){ preview.textContent="Bitte Passwort und Text eingeben."; info.textContent=""; copyBtn.style.display="none"; return; }
  preview.textContent="Verarbeite…"; info.textContent=""; copyBtn.style.display="none";

  try{
    const chalResp = await fetchWithRetry(SERVER_URL+"/api/challenge",{method:"POST"});
    const chData = await chalResp.json();
    const payload = { password:pw, data:tx, challenge:chData.challenge, nonce:crypto.randomUUID() };
    const mainResp = await fetchWithRetry(`${SERVER_URL}/api/${mode}`,{method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
    const resData = await mainResp.json();
    full = resData.result || "";
    if(full){ preview.textContent = shorten(full); info.textContent = full.length+" Zeichen"; copyBtn.style.display="inline-block"; }
    else { preview.textContent=resData.error||"Fehler: Kein Ergebnis."; info.textContent=""; }
  }catch(e){
    console.error(e);
    preview.textContent="Fehler: Server nicht erreichbar."; info.textContent=""; copyBtn.style.display="none";
  }
}

function copy(){
  if(full){ navigator.clipboard.writeText(full); document.getElementById('info').textContent="Kopiert"; }
  else document.getElementById('info').textContent="Nichts zum Kopieren.";
}

async function resetBadClient(){
  try{
    const resp = await fetch(SERVER_URL+"/internal/reset-badclients",{method:"POST"});
    const data = await resp.json();
    alert("BadClient Reset: "+(data.status||"fertig"));
  }catch(e){
    console.error(e); alert("Reset fehlgeschlagen!");
  }
}
</script>
</body>
</html>
