<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Messenger WhatsApp Style</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  body, html {
    margin:0;
    padding:0;
    height:100%;
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color:#121c21;
    display:flex;
    flex-direction:column;
  }

  /* Login Screen */
  #loginContainer {
    flex:1;
    display:flex;
    justify-content:center;
    align-items:center;
    flex-direction:column;
    background-color:#121c21;
    padding:20px;
  }

  #loginContainer input {
    width:100%;
    max-width:350px;
    padding:12px;
    margin:8px 0;
    border-radius:25px;
    border:none;
    background-color:#2a3b3a;
    color:#e5ddd5;
    font-size:16px;
  }

  #loginContainer button {
    width:100%;
    max-width:350px;
    padding:12px;
    margin-top:10px;
    border-radius:25px;
    border:none;
    background-color:#25d366;
    color:white;
    font-size:16px;
    cursor:pointer;
  }

  #loginContainer button:hover { background-color:#128c7e; }

  /* Chat Screen */
  #chatContainer {
    display:none;
    flex:1;
    flex-direction:column;
    background-color:#121c21;
  }

  #chatHeader {
    background-color:#075e54;
    color:#fff;
    padding:15px;
    font-weight:bold;
    font-size:18px;
  }

  #chat {
    flex:1;
    padding:10px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
  }

  .message {
    max-width:70%;
    padding:10px 14px;
    margin:4px 0;
    border-radius:20px;
    word-wrap: break-word;
    font-size:15px;
  }

  .sent { background-color:#25d366; color:#fff; align-self:flex-end; border-bottom-right-radius:0;}
  .received { background-color:#2a3b3a; color:#e5ddd5; align-self:flex-start; border-bottom-left-radius:0;}
  .system { text-align:center; font-style:italic; color:#b0baba; }

  #inputArea {
    display:flex;
    padding:10px;
    background-color:#2a3b3a;
  }

  #message {
    flex:1;
    padding:10px;
    border-radius:25px;
    border:none;
    font-size:16px;
    background-color:#121c21;
    color:#e5ddd5;
  }

  #sendBtn {
    margin-left:10px;
    padding:10px 18px;
    border-radius:25px;
    border:none;
    background-color:#25d366;
    color:white;
    font-size:16px;
    cursor:pointer;
  }

  #sendBtn:hover { background-color:#128c7e; }

  #disconnectBtn {
    margin-top:5px;
    padding:10px 18px;
    border-radius:25px;
    border:none;
    background-color:#ff3b3b;
    color:white;
    font-size:14px;
    cursor:pointer;
  }

  #disconnectBtn:hover { background-color:#cc0000; }
</style>
</head>
<body>

<div id="loginContainer">
  <input type="text" id="userIdInput" placeholder="Deine User-ID">
  <input type="text" id="targetIdInput" placeholder="EmpfÃ¤nger User-ID">
  <button id="loginBtn">Login & Chat starten</button>
  <div class="system" id="loginFeedback"></div>
</div>

<div id="chatContainer">
  <div id="chatHeader"></div>
  <div id="chat"></div>
  <div id="inputArea">
    <input type="text" id="message" placeholder="Nachricht eingeben...">
    <button id="sendBtn">Senden</button>
  </div>
  <button id="disconnectBtn">Verbindung trennen</button>
</div>

<script>
const SERVER_URL = 'wss://unwintry-strapping-winford.ngrok-free.dev';
let ws;
let userId = '';
let targetId = '';
const SECRET_KEY = "supergeheimeschluessel"; // AES Demo

const loginContainer = document.getElementById('loginContainer');
const chatContainer = document.getElementById('chatContainer');
const chatDiv = document.getElementById('chat');
const chatHeader = document.getElementById('chatHeader');
const loginFeedback = document.getElementById('loginFeedback');

function logMessage(text, type='system'){
  const div = document.createElement('div');
  div.textContent = text;
  div.className = 'message ' + type;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

document.getElementById('loginBtn').onclick = () => {
  const uId = document.getElementById('userIdInput').value.trim();
  const tId = document.getElementById('targetIdInput').value.trim();
  if(!uId || !tId){
    loginFeedback.textContent = "Bitte beide User-IDs eingeben!";
    return;
  }

  userId = uId;
  targetId = tId;

  ws = new WebSocket(SERVER_URL);

  ws.onopen = () => {
    ws.send(JSON.stringify({type:'register', userId}));
    loginContainer.style.display='none';
    chatContainer.style.display='flex';
    chatHeader.textContent = "Chat mit: " + targetId;
    logMessage("Verbunden mit Server", 'system');
  };

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if(data.from && data.text && data.from === targetId){
      const decrypted = CryptoJS.AES.decrypt(data.text, SECRET_KEY).toString(CryptoJS.enc.Utf8);
      logMessage(data.from + ": " + decrypted, 'received');
    }
  };

  ws.onclose = () => logMessage("Verbindung geschlossen", 'system');
};

document.getElementById('sendBtn').onclick = () => {
  const text = document.getElementById('message').value.trim();
  if(!text || !ws || ws.readyState!==WebSocket.OPEN) return;
  const encrypted = CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
  ws.send(JSON.stringify({type:'message', to:targetId, text:encrypted}));
  logMessage("Du: " + text, 'sent');
  document.getElementById('message').value='';
};

document.getElementById('disconnectBtn').onclick = () => {
  if(ws) ws.close();
  chatContainer.style.display='none';
  loginContainer.style.display='flex';
  chatDiv.innerHTML=''; // Chat leeren
  logMessage("Verbindung beendet", 'system');
};
</script>

</body>
</html>
