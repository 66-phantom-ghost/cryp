<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mini Messenger WebApp</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background-color:#121212;
  color:#f0f0f0;
  height:100vh;
  display:flex;
  flex-direction:column;
}
#header {background-color:#1e1e1e; padding:10px; text-align:center; border-bottom:2px solid #ff3b3b;}
#container {flex:1; display:flex; overflow:hidden; height:100%;}
#contacts {
  width:180px;
  background-color:#1e1e1e;
  border-right:2px solid #ff3b3b;
  padding:10px;
  box-sizing:border-box;
  overflow-y:auto;
}
#contacts h3 {color:#ff3b3b; margin-top:0;}
.contact {padding:6px; margin:5px 0; background-color:#2a2a2a; border-radius:4px; cursor:pointer;}
.contact:hover {background-color:#ff3b3b; color:#121212;}
#chat-area {flex:1; display:flex; flex-direction:column;}
#chat-header {background-color:#1e1e1e; padding:10px; border-bottom:2px solid #ff3b3b; font-weight:bold;}
#chat-messages {flex:1; padding:10px; overflow-y:auto;}
.message {padding:6px 10px; margin:5px 0; border-radius:10px; max-width:70%; word-wrap:break-word;}
.sent {background-color:#ff3b3b; color:#fff; align-self:flex-end;}
.received {background-color:#2a2a2a; color:#f0f0f0; align-self:flex-start;}
.system {font-style:italic; color:#ff3b3b; text-align:center;}
#chat-input {display:flex; padding:10px; border-top:2px solid #ff3b3b; background-color:#1e1e1e;}
#chat-input input {flex:1; padding:8px; border-radius:4px; border:none; background-color:#2a2a2a; color:#f0f0f0;}
#chat-input button {margin-left:5px; padding:8px 12px; border-radius:4px; border:none; background-color:#ff3b3b; color:#fff; cursor:pointer;}
#chat-input button:hover {background-color:#ff1a1a;}
#add-contact {display:flex; margin-top:10px;}
#add-contact input {flex:1; padding:6px; border-radius:4px; border:none; background-color:#2a2a2a; color:#f0f0f0;}
#add-contact button {margin-left:5px; padding:6px 10px; border-radius:4px; border:none; background-color:#ff3b3b; color:#fff; cursor:pointer;}
#add-contact button:hover {background-color:#ff1a1a;}
@media(max-width:600px){
  #container {flex-direction:column;}
  #contacts {width:100%; height:120px; display:flex; overflow-x:auto; overflow-y:hidden;}
  .contact {flex:0 0 auto; margin-right:5px;}
  #add-contact {flex:1; display:flex;}
}
</style>
</head>
<body>

<div id="header"><strong>Mini Messenger WebApp</strong></div>

<div id="container">
  <div id="contacts">
    <h3>Kontakte</h3>
    <div id="add-contact">
      <input type="text" id="newContactName" placeholder="Name">
      <button id="addContactBtn">+</button>
    </div>
  </div>

  <div id="chat-area">
    <div id="chat-header">Kein Kontakt ausgewählt</div>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="message" placeholder="Nachricht eingeben...">
      <button id="sendBtn">Senden</button>
    </div>
  </div>
</div>

<script>
const SERVER_URL = 'wss://unwintry-strapping-winford.ngrok-free.dev';
let ws;
let userId = prompt("Gib deine User-ID ein:", "user" + Math.floor(Math.random()*1000));
let currentContact = null;
let contacts = {}; // contactId -> Array von Nachrichten
const SECRET_KEY = "supergeheimeschluessel";

// WebSocket-Verbindung
ws = new WebSocket(SERVER_URL);
ws.onopen = () => { ws.send(JSON.stringify({type:'register', userId})); console.log("Verbunden als", userId);}
ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if(data.from && data.text){
    addContact(data.from, false, data.from); // automatisch hinzufügen
    const decrypted = CryptoJS.AES.decrypt(data.text, SECRET_KEY).toString(CryptoJS.enc.Utf8);
    logMessage(data.from, decrypted, 'received');
  }
};

// Kontakt hinzufügen
function addContact(name, promptId=true, id=null){
  if(!id && promptId){
    id = prompt("Gib die User-ID für "+name+" ein:");
    if(!id) return alert("User-ID benötigt!");
  }
  if(document.getElementById(id)) return; // schon vorhanden
  const contactsDiv = document.getElementById('contacts');
  const div = document.createElement('div');
  div.textContent = name;
  div.className='contact';
  div.id=id;
  div.onclick = ()=>renderChat(id);
  contactsDiv.appendChild(div);
  contacts[id] = contacts[id]||[];
}

// Chat rendern
function renderChat(contact){
  currentContact = contact;
  document.getElementById('chat-header').textContent = contact;
  const chatDiv = document.getElementById('chat-messages');
  chatDiv.innerHTML='';
  contacts[contact].forEach(msg=>{
    const div=document.createElement('div');
    div.textContent=msg.text;
    div.className='message '+msg.type;
    chatDiv.appendChild(div);
  });
  chatDiv.scrollTop=chatDiv.scrollHeight;
}

// Nachricht senden
document.getElementById('sendBtn').onclick = ()=>{
  const text = document.getElementById('message').value.trim();
  if(!currentContact){ alert("Bitte wähle einen Kontakt aus!"); return; }
  if(!text) return;

  const encrypted = CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
  ws.send(JSON.stringify({type:'message', to: currentContact, text: encrypted}));
  logMessage(currentContact, text, 'sent');
  document.getElementById('message').value='';
}

// Nachrichten loggen
function logMessage(contact, text, type){
  if(!contacts[contact]) contacts[contact]=[];
  contacts[contact].push({text,type});
  if(contact===currentContact) renderChat(contact);
}

// Button Kontakt hinzufügen
document.getElementById('addContactBtn').onclick = ()=>{
  const name = document.getElementById('newContactName').value.trim();
  if(!name) return alert("Name eingeben!");
  addContact(name, true);
  document.getElementById('newContactName').value='';
}
</script>

</body>
</html>
