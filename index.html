<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Mini Messenger Pro</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #121212;
    color: #f0f0f0;
    height: 100vh;
    display: flex;
    overflow: hidden;
  }

  /* Kontakte-Liste */
  #contacts {
    width: 200px;
    background-color: #1e1e1e;
    border-right: 2px solid #ff3b3b;
    padding: 10px;
    box-sizing: border-box;
    overflow-y: auto;
  }

  #contacts h3 {
    color: #ff3b3b;
    margin-top: 0;
  }

  .contact {
    padding: 8px;
    margin: 5px 0;
    background-color: #2a2a2a;
    cursor: pointer;
    border-radius: 4px;
  }

  .contact:hover {
    background-color: #ff3b3b;
    color: #121212;
  }

  /* Chat-Bereich */
  #chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #chat-header {
    background-color: #1e1e1e;
    border-bottom: 2px solid #ff3b3b;
    padding: 10px;
    font-weight: bold;
  }

  #chat-messages {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    background-color: #121212;
  }

  .message {
    padding: 6px 10px;
    margin: 5px 0;
    border-radius: 10px;
    max-width: 70%;
    word-wrap: break-word;
  }

  .sent {
    background-color: #ff3b3b;
    color: #fff;
    align-self: flex-end;
  }

  .received {
    background-color: #2a2a2a;
    color: #f0f0f0;
    align-self: flex-start;
  }

  #chat-input {
    display: flex;
    padding: 10px;
    background-color: #1e1e1e;
    border-top: 2px solid #ff3b3b;
  }

  #chat-input input {
    flex: 1;
    padding: 8px;
    border-radius: 4px;
    border: none;
    background-color: #2a2a2a;
    color: #f0f0f0;
  }

  #chat-input button {
    margin-left: 5px;
    padding: 8px 12px;
    border-radius: 4px;
    border: none;
    background-color: #ff3b3b;
    color: #fff;
    cursor: pointer;
  }

  #chat-input button:hover {
    background-color: #ff1a1a;
  }

  /* System Nachrichten */
  .system {
    font-style: italic;
    color: #ff3b3b;
    text-align: center;
  }
</style>
</head>
<body>

<div id="contacts">
  <h3>Kontakte</h3>
  <!-- Dynamisch gefüllte Kontakte -->
</div>

<div id="chat-area">
  <div id="chat-header">Kein Kontakt ausgewählt</div>
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="message" placeholder="Nachricht eingeben...">
    <button id="sendBtn">Senden</button>
  </div>
</div>

<script>
const SERVER_URL = 'wss://unwintry-strapping-winford.ngrok-free.dev';
let ws;
let userId = prompt("Gib deine User-ID ein:", "user" + Math.floor(Math.random()*1000));
let currentContact = null;
const contacts = {}; // contactId -> Nachrichten-Array

function logMessage(contact, text, type='received') {
  if(!contacts[contact]) contacts[contact] = [];
  contacts[contact].push({text, type});
  if(contact === currentContact) renderChat(contact);
}

function renderChat(contact) {
  currentContact = contact;
  document.getElementById('chat-header').textContent = contact;
  const chatDiv = document.getElementById('chat-messages');
  chatDiv.innerHTML = '';
  contacts[contact].forEach(msg => {
    const div = document.createElement('div');
    div.textContent = msg.text;
    div.className = 'message ' + msg.type;
    chatDiv.appendChild(div);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function addContact(contact) {
  if(document.getElementById(contact)) return;
  const contactsDiv = document.getElementById('contacts');
  const div = document.createElement('div');
  div.textContent = contact;
  div.className = 'contact';
  div.id = contact;
  div.onclick = () => renderChat(contact);
  contactsDiv.appendChild(div);
}

function sendMessage() {
  const text = document.getElementById('message').value.trim();
  if(!currentContact) return alert("Bitte wähle einen Kontakt aus!");
  if(!text) return;
  ws.send(JSON.stringify({type:'message', to: currentContact, text}));
  logMessage(currentContact, text, 'sent');
  document.getElementById('message').value = '';
}

document.getElementById('sendBtn').onclick = sendMessage;

ws = new WebSocket(SERVER_URL);

ws.onopen = () => {
  ws.send(JSON.stringify({type:'register', userId}));
  console.log("Verbunden als", userId);
};

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if(data.from) {
    addContact(data.from);
    logMessage(data.from, data.text, 'received');
  }
};
</script>

</body>
</html>
