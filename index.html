<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server-gebundene VerschlÃ¼sselung</title>

<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
</style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-xl bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700">
  <h1 class="text-3xl font-bold text-green-400 mb-4 text-center">ğŸ” Serverâ€‘gebundene Kryptoâ€‘Box</h1>

  <input id="msg" placeholder="Text" class="w-full p-3 mb-3 bg-gray-700 rounded-lg">
  <input id="password" type="password" placeholder="Passwort (Pflicht)" class="w-full p-3 mb-3 bg-gray-700 rounded-lg">
  <input id="extra1" placeholder="Zusatz 1 (optional)" class="w-full p-3 mb-2 bg-gray-700 rounded-lg">
  <input id="extra2" placeholder="Zusatz 2 (optional)" class="w-full p-3 mb-2 bg-gray-700 rounded-lg">
  <input id="extra3" placeholder="Zusatz 3 (optional)" class="w-full p-3 mb-4 bg-gray-700 rounded-lg">

  <div class="flex gap-3">
    <button onclick="encrypt()" class="flex-1 p-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
      ğŸ”’ VerschlÃ¼sseln
    </button>
    <button onclick="decrypt()" class="flex-1 p-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold">
      ğŸ”“ EntschlÃ¼sseln
    </button>
  </div>

  <pre id="out" class="mt-6 p-4 bg-gray-700 rounded-lg h-56 overflow-auto text-sm">
Bereit.
  </pre>
</div>

<script>
const API = "https://unwintry-strapping-winford.ngrok-free.dev/api/approve";
const TOKEN = "d9F3kL1bQ7rXp2VwZ8nM5tC4sJ6yH0uR";

async function sha256(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

async function deriveKey(msg, pwd, e1, e2, e3) {
  const base = msg + "|" + pwd + "|" + e1 + "|" + e2 + "|" + e3;
  const clientHash = await sha256(base);

  const res = await fetch(API, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-API-Token": TOKEN
    },
    body: JSON.stringify({ clientHash })
  });

  const data = await res.json();
  if (!res.ok || !data.ok) throw new Error("Server verweigert");

  return await sha256(clientHash + data.approval);
}

async function encrypt() {
  const out = document.getElementById("out");
  const msg = document.getElementById("msg").value;
  const pwd = document.getElementById("password").value;
  const e1 = extra1.value || "", e2 = extra2.value || "", e3 = extra3.value || "";

  if (!msg || !pwd) {
    out.textContent = "âŒ Text & Passwort sind Pflicht";
    return;
  }

  out.textContent = "â³ VerschlÃ¼sselungâ€¦";

  try {
    const keyHex = await deriveKey(msg, pwd, e1, e2, e3);
    const key = await crypto.subtle.importKey(
      "raw",
      Uint8Array.from(keyHex.match(/../g).map(b => parseInt(b,16))),
      "AES-GCM",
      false,
      ["encrypt"]
    );

    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      key,
      new TextEncoder().encode(msg)
    );

    const result = {
      iv: btoa(String.fromCharCode(...iv)),
      data: btoa(String.fromCharCode(...new Uint8Array(enc)))
    };

    out.textContent = "âœ… VerschlÃ¼sselt:\n\n" + JSON.stringify(result, null, 2);
  } catch {
    out.textContent = "âŒ VerschlÃ¼sselung fehlgeschlagen";
  }
}

async function decrypt() {
  const out = document.getElementById("out");
  const pwd = password.value;
  const e1 = extra1.value || "", e2 = extra2.value || "", e3 = extra3.value || "";

  if (!pwd) {
    out.textContent = "âŒ Passwort fehlt";
    return;
  }

  let payload;
  try {
    payload = JSON.parse(msg.value);
  } catch {
    out.textContent = "âŒ Kein gÃ¼ltiger Ciphertext (JSON)";
    return;
  }

  out.textContent = "â³ EntschlÃ¼sselungâ€¦";

  try {
    const keyHex = await deriveKey("decrypt", pwd, e1, e2, e3);
    const key = await crypto.subtle.importKey(
      "raw",
      Uint8Array.from(keyHex.match(/../g).map(b => parseInt(b,16))),
      "AES-GCM",
      false,
      ["decrypt"]
    );

    const iv = Uint8Array.from(atob(payload.iv), c => c.charCodeAt(0));
    const data = Uint8Array.from(atob(payload.data), c => c.charCodeAt(0));

    const dec = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
    out.textContent = "ğŸ”“ EntschlÃ¼sselt:\n\n" + new TextDecoder().decode(dec);
  } catch {
    out.textContent = "âŒ EntschlÃ¼sselung fehlgeschlagen (Server / Passwort / Extras falsch)";
  }
}
</script>

</body>
</html>
