<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto-Gate Client</title>
<style>
/* Farbschema: Schwarz / Rot / Grün */
:root {
  --bg: #000000;
  --card: #0a0a0a;
  --panel: #111111;
  --accent: #FF073A;
  --accent-dark: #C0042D;
  --accent2: #00FF41;
  --accent2-dark: #00C834;
  --text: #e5e7eb;
  --muted: #888;
  --glow-red: rgba(255, 7, 58, 0.4);
  --glow-green: rgba(0, 255, 65, 0.4);
}

body {
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  font-family:'Inter', sans-serif;
  background: radial-gradient(circle at center, #1a0000 0%, var(--bg) 80%);
  color: var(--text);
}

.container {
  max-width:500px;
  width:90%;
  padding:20px;
}

.card {
  background: var(--card);
  border-radius:16px;
  padding:30px;
  box-shadow:0 0 50px var(--glow-red),0 10px 20px rgba(0,0,0,0.8), inset 0 0 0 1px rgba(255,255,255,0.08);
}

header {
  text-align:center;
  margin-bottom:20px;
}

header h1 {
  margin:0;
  color: var(--accent);
  font-size:1.8rem;
}

header p {
  color: var(--muted);
  font-size:0.85rem;
}

label {
  display:block;
  margin-bottom:6px;
  font-size:0.8rem;
  color: var(--muted);
}

input, textarea {
  width:100%;
  padding:12px;
  margin-bottom:16px;
  border:none;
  border-radius:10px;
  background: var(--panel);
  color: var(--text);
  font-size:0.95rem;
  outline:none;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  transition:box-shadow 0.3s ease;
}

input:focus, textarea:focus {
  box-shadow: 0 0 0 2px var(--accent), inset 0 0 0 1px var(--accent);
}

textarea { resize: vertical; min-height:90px; }

.actions {
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px;
  margin-bottom:20px;
}

button {
  padding:12px;
  font-weight:700;
  border:none;
  border-radius:10px;
  cursor:pointer;
  transition:transform 0.15s ease, box-shadow 0.3s ease;
}

button:hover { transform:translateY(-2px); }

.encrypt {
  background: linear-gradient(135deg, var(--accent), var(--accent-dark));
  color:white;
  box-shadow:0 10px 25px var(--glow-red);
}

.decrypt {
  background: linear-gradient(135deg, var(--accent2), var(--accent2-dark));
  color: var(--card);
  box-shadow:0 10px 25px var(--glow-green);
}

.reset {
  background: #333;
  color: var(--text);
  font-size:0.8rem;
}

.output {
  background: var(--panel);
  border-radius:12px;
  padding:12px;
  font-family: monospace;
  font-size:0.85rem;
  word-break: break-all;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
  margin-bottom:10px;
  min-height:50px;
  color: #00FFFF;
}

.copy {
  background: transparent;
  border: 1px solid var(--accent2);
  color: var(--accent2);
  padding:6px 10px;
  border-radius:8px;
  font-size:0.75rem;
  cursor:pointer;
}
.copy:hover {
  background: rgba(0,255,65,0.1);
  box-shadow: 0 0 8px rgba(0,255,65,0.4);
}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <header>
      <h1>Crypto-Gate</h1>
      <p>Private · Minimal · Secure</p>
    </header>

    <label for="password">Passwort</label>
    <input id="password" type="password" placeholder="••••••••">

    <label for="text">Text</label>
    <textarea id="text" placeholder="Klartext oder verschlüsselter Inhalt"></textarea>

    <div class="actions">
      <button class="encrypt" onclick="run('encrypt')">Verschlüsseln</button>
      <button class="decrypt" onclick="run('decrypt')">Entschlüsseln</button>
      <button class="reset" onclick="resetServer()">Reset BadClients</button>
    </div>

    <div class="output" id="preview">Bereit.</div>
    <button class="copy" onclick="copy()" id="copyBtn" style="display:none">Kopieren</button>
  </div>
</div>

<script>
const SERVER = "https://unwintry-strapping-winford.ngrok-free.dev";

let full = "";

async function fetchWithRetry(url, options, retries=3){
  for(let i=0;i<retries;i++){
    try{
      const res = await fetch(url, options);
      if(!res.ok) throw new Error(`HTTP error ${res.status}`);
      return res;
    }catch(e){
      if(i<retries-1) await new Promise(r=>setTimeout(r,500*(i+1)));
      else throw e;
    }
  }
}

function shorten(s){
  if(s.length<48) return s;
  return s.slice(0,22)+"…"+s.slice(-22);
}

async function run(mode){
  const pw = password.value.trim();
  const tx = text.value.trim();
  if(!pw||!tx){ preview.textContent="Passwort und Text eingeben."; copyBtn.style.display="none"; return; }

  preview.textContent="Verarbeite…"; copyBtn.style.display="none";

  try{
    const chalResp = await fetchWithRetry(SERVER+"/api/challenge",{method:"POST"});
    const chalJson = await chalResp.json();
    const challenge = chalJson.challenge;

    const mainResp = await fetchWithRetry(SERVER+"/api/"+mode,{
      method:"POST",
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ password:pw, data:tx, challenge:challenge, nonce:crypto.randomUUID(), signature:"" })
    });

    const resJson = await mainResp.json();
    full = resJson.result || "";
    if(full){ preview.textContent=shorten(full); copyBtn.style.display="inline-block"; }
    else preview.textContent=resJson.error || "Fehler: Ergebnis fehlt";

  }catch(e){
    console.error(e);
    preview.textContent="Fehler: Server nicht erreichbar";
  }
}

function copy(){
  if(full){
    navigator.clipboard.writeText(full);
  }
}

async function resetServer(){
  try{
    const resp = await fetch(SERVER+"/internal/reset",{method:"POST"});
    const json = await resp.json();
    alert("Server Reset: "+json.message);
  }catch(e){
    alert("Fehler beim Reset");
  }
}

const password = document.getElementById("password");
const text = document.getElementById("text");
const preview = document.getElementById("preview");
const copyBtn = document.getElementById("copyBtn");
</script>
</body>
</html>
