<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto-Gate Client</title>
<style>
:root {
  --bg: #000000;
  --card: #0a0a0a;
  --panel: #0d0d00;
  --accent-red: #FF073A;
  --accent-green: #00FF41;
  --text: #e5e7eb;
  --muted: #888;
  --glow-red: rgba(255,7,58,0.4);
  --glow-green: rgba(0,255,65,0.4);
  --border: rgba(255,255,255,0.08);
}

body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at center, #1a0000 0%, #000000 80%);
  font-family: 'Inter', sans-serif;
  color: var(--text);
  display: flex;
  justify-content: center;
  align-items: center;
}

.container {
  max-width: 480px;
  width: 90%;
  background: var(--card);
  padding: 28px;
  border-radius: 16px;
  box-shadow: 0 0 50px var(--glow-red), 0 10px 20px rgba(0,0,0,.8), inset 0 0 0 1px var(--border);
}

h1 {
  text-align: center;
  color: var(--accent-red);
  margin-bottom: 10px;
}

label {
  display: block;
  margin-top: 12px;
  margin-bottom: 4px;
  font-size: 0.85rem;
  color: var(--muted);
}

input, textarea {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: var(--panel);
  color: var(--text);
  font-size: 0.95rem;
  outline: none;
  margin-bottom: 14px;
  box-shadow: inset 0 0 0 1px var(--border);
}

input:focus, textarea:focus {
  box-shadow: 0 0 0 2px var(--accent-red), inset 0 0 0 1px var(--accent-red);
}

textarea { min-height: 90px; resize: vertical; }

.actions {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

button {
  flex: 1;
  padding: 12px;
  font-weight: 700;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: transform 0.15s ease, box-shadow 0.3s ease, opacity 0.15s;
}

button:hover { transform: translateY(-2px); opacity: 0.95; }

.encrypt {
  background: linear-gradient(135deg, var(--accent-red), #C0042D);
  color: white;
  box-shadow: 0 10px 25px var(--glow-red);
}

.decrypt {
  background: linear-gradient(135deg, var(--accent-green), #00C834);
  color: var(--card);
  box-shadow: 0 10px 25px var(--glow-green);
}

.output {
  background: var(--panel);
  padding: 14px;
  border-radius: 12px;
  font-family: monospace;
  font-size: 0.85rem;
  word-break: break-all;
  box-shadow: inset 0 0 0 1px var(--border);
  min-height: 60px;
  color: #00FFFF;
}

.copy {
  margin-top: 8px;
  padding: 6px 12px;
  border-radius: 8px;
  background: transparent;
  border: 1px solid var(--accent-green);
  color: var(--accent-green);
  cursor: pointer;
  transition: background 0.2s, box-shadow 0.2s;
}

.copy:hover {
  background: rgba(0,255,65,0.1);
  box-shadow: 0 0 8px var(--glow-green);
}

.reset {
  margin-top: 12px;
  padding: 8px 14px;
  border-radius: 10px;
  background: var(--accent-red);
  color: white;
  cursor: pointer;
  font-weight: bold;
  width: 100%;
}

.reset:hover {
  box-shadow: 0 0 12px var(--glow-red);
}
</style>
</head>
<body>
<div class="container">
  <h1>Crypto-Gate</h1>

  <label for="password">Passwort</label>
  <input type="password" id="password" placeholder="••••••••">

  <label for="text">Text</label>
  <textarea id="text" placeholder="Klartext oder verschlüsselte Nachricht"></textarea>

  <div class="actions">
    <button class="encrypt" onclick="run('encrypt')">Verschlüsseln</button>
    <button class="decrypt" onclick="run('decrypt')">Entschlüsseln</button>
  </div>

  <div class="output" id="result">Bereit.</div>
  <button class="copy" onclick="copyResult()" id="copyBtn" style="display:none">Kopieren</button>
  <button class="reset" onclick="resetBadClients()">Reset BadClient</button>
</div>

<script>
const SERVER = "https://unwintry-strapping-winford.ngrok-free.dev";
let fullResult = "";

function generateNonce() {
  return Array.from(crypto.getRandomValues(new Uint8Array(16)))
              .map(b => b.toString(16).padStart(2,'0'))
              .join('');
}

async function requestChallenge() {
  const res = await fetch(`${SERVER}/api/challenge`, { method: 'POST' });
  if (!res.ok) throw new Error(`Challenge fehlgeschlagen: ${res.status}`);
  return (await res.json()).challenge;
}

async function run(mode) {
  const pw = document.getElementById("password").value.trim();
  const tx = document.getElementById("text").value.trim();
  const resultEl = document.getElementById("result");
  const copyBtn = document.getElementById("copyBtn");

  if (!pw || !tx) {
    resultEl.textContent = "Bitte Passwort und Text eingeben.";
    copyBtn.style.display = "none";
    return;
  }

  resultEl.textContent = "Verarbeite…";
  copyBtn.style.display = "none";

  try {
    const challenge = await requestChallenge();
    const nonce = generateNonce();

    const res = await fetch(`${SERVER}/api/${mode}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pw, data: tx, challenge, nonce, signature: "" })
    });

    if (!res.ok) throw new Error(`Server antwortete mit ${res.status}`);

    const data = await res.json();
    if (data.result) {
      fullResult = data.result;
      resultEl.textContent = fullResult.length > 60 ? fullResult.slice(0,30)+'…'+fullResult.slice(-30) : fullResult;
      copyBtn.style.display = "inline-block";
    } else {
      resultEl.textContent = data.error || "Keine Daten vom Server.";
    }

  } catch(err) {
    resultEl.textContent = `FEHLER: ${err.message}`;
    console.error(err);
  }
}

function copyResult() {
  if (!fullResult) return;
  navigator.clipboard.writeText(fullResult);
}

async function resetBadClients() {
  try {
    const res = await fetch(`${SERVER}/internal/reset-badclients`, { method: 'POST' });
    if (res.ok) {
      document.getElementById("result").textContent = "BadClients zurückgesetzt. Neue Challenge bitte abrufen.";
    } else {
      document.getElementById("result").textContent = "Reset fehlgeschlagen.";
    }
  } catch(e) {
    document.getElementById("result").textContent = "Reset fehlgeschlagen: Server nicht erreichbar.";
  }
}
</script>
</body>
</html>
