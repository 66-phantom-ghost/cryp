<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto-Gate Frontend</title>
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #1e1e2f, #2d2d44);
  color: #f0f0f0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  padding: 20px;
}
h1 { color: #00ffff; }
input, textarea, button {
  width: 100%;
  max-width: 500px;
  margin: 5px 0;
  padding: 10px;
  border-radius: 8px;
  border: none;
  outline: none;
}
button {
  background: #00ffff;
  color: #1e1e2f;
  font-weight: bold;
  cursor: pointer;
  transition: 0.2s;
}
button:hover { background: #00d6d6; }
textarea { height: 150px; resize: none; background: #2d2d44; color: #f0f0f0; }
.result { word-break: break-all; margin-top: 10px; }
</style>
</head>
<body>

<h1>Crypto-Gate Frontend</h1>

<input type="password" id="password" placeholder="Passwort">
<textarea id="data" placeholder="Hier den Text eingeben"></textarea>
<button id="encryptBtn">Verschlüsseln</button>
<button id="decryptBtn">Entschlüsseln</button>

<div class="result" id="result"></div>

<script>
const SERVER = "https://unwintry-strapping-winford.ngrok-free.dev";

async function getChallenge() {
  const resp = await fetch(`${SERVER}/api/challenge`, { method: 'POST' });
  if (!resp.ok) throw new Error('Challenge fehlgeschlagen');
  const data = await resp.json();
  return data.challenge;
}

function generateNonce() {
  return crypto.getRandomValues(new Uint8Array(16)).reduce((s,b)=>s+b.toString(16).padStart(2,'0'),'');
}

async function sendCrypto(mode) {
  try {
    const password = document.getElementById('password').value;
    const data = document.getElementById('data').value;
    const challenge = await getChallenge();
    const nonce = generateNonce();

    // Sign payload: {challenge, nonce, mode}
    const payloadStr = JSON.stringify({challenge, nonce, mode});
    const enc = new TextEncoder();
    const key = await crypto.subtle.importKey('raw', enc.encode(challenge), {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
    const sigBuf = await crypto.subtle.sign('HMAC', key, enc.encode(payloadStr));
    const signature = Array.from(new Uint8Array(sigBuf)).map(b=>b.toString(16).padStart(2,'0')).join('');

    const resp = await fetch(`${SERVER}/api/${mode}`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ challenge, nonce, password, data, signature })
    });

    if (!resp.ok) throw new Error('Fehler bei der Serveranfrage');
    const json = await resp.json();
    document.getElementById('result').innerText = json.result;
  } catch(e) {
    document.getElementById('result').innerText = "Fehler: " + e.message;
  }
}

document.getElementById('encryptBtn').addEventListener('click', ()=>sendCrypto('encrypt'));
document.getElementById('decryptBtn').addEventListener('click', ()=>sendCrypto('decrypt'));
</script>

</body>
</html>
