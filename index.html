<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Secure Crypto Gateway</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<style>
body {
  background: radial-gradient(circle at top, #0f172a, #020617);
}
.fade-in {
  animation: fade 0.6s ease-out;
}
@keyframes fade {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center text-slate-200">

<div class="w-full max-w-xl p-6 bg-slate-900/90 rounded-xl shadow-2xl border border-slate-700 fade-in">
  <h1 class="text-2xl font-bold text-cyan-400 mb-2">ğŸ” Secure Encryption Gateway</h1>
  <p class="text-xs text-slate-400 mb-6">
    VerschlÃ¼sselung nur mit Server-Freigabe Â· PBKDF2 Â· AESâ€‘256â€‘GCM
  </p>

  <!-- Passwort -->
  <input id="pw" type="password" placeholder="Pflichtâ€‘Passwort"
    class="w-full mb-3 p-3 bg-slate-800 border border-slate-600 rounded focus:ring-2 focus:ring-cyan-400">

  <!-- Zusatz-Faktoren -->
  <input id="f1" type="password" placeholder="Zusatzâ€‘Faktor 1 (optional)"
    class="w-full mb-2 p-2 bg-slate-800 border border-slate-700 rounded">
  <input id="f2" type="password" placeholder="Zusatzâ€‘Faktor 2 (optional)"
    class="w-full mb-2 p-2 bg-slate-800 border border-slate-700 rounded">
  <input id="f3" type="password" placeholder="Zusatzâ€‘Faktor 3 (optional)"
    class="w-full mb-4 p-2 bg-slate-800 border border-slate-700 rounded">

  <!-- Klartext -->
  <textarea id="plain" rows="3" placeholder="Text eingeben"
    class="w-full p-3 bg-black border border-cyan-600 rounded mb-4"></textarea>

  <!-- Buttons -->
  <div class="flex gap-3 mb-4">
    <button onclick="encrypt()"
      class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-black font-bold py-2 rounded">
      ğŸ”’ VerschlÃ¼sseln
    </button>
    <button onclick="decrypt()"
      class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-black font-bold py-2 rounded">
      ğŸ”“ EntschlÃ¼sseln
    </button>
  </div>

  <!-- Ausgabe -->
  <pre id="out"
    class="min-h-[90px] p-3 bg-black border border-slate-700 rounded text-xs overflow-auto">
Wartenâ€¦
  </pre>
</div>

<script>
/* ================== KONFIG ================== */
const SERVER = "https://unwintry-strapping-winford.ngrok-free.dev/api/approve";
const PBKDF2_ROUNDS = 1_000_000;
const ENC = new TextEncoder();
const DEC = new TextDecoder();

/* ================== HASH ================== */
async function sha256(data) {
  const buf = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
}

/* ================== KEY ================== */
async function deriveKey(password, serverApproval) {
  const baseKey = await crypto.subtle.importKey(
    "raw",
    ENC.encode(password + serverApproval),
    "PBKDF2",
    false,
    ["deriveKey"]
  );

  return crypto.subtle.deriveKey(
    {
      name: "PBKDF2",
      salt: ENC.encode("secure-gateway"),
      iterations: PBKDF2_ROUNDS,
      hash: "SHA-256"
    },
    baseKey,
    { name: "AES-GCM", length: 256 },
    false,
    ["encrypt","decrypt"]
  );
}

/* ================== ENCRYPT ================== */
async function encrypt() {
  const pw = pwVal();
  if (!pw) return msg("âŒ Passwort fehlt");

  const clientHash = await sha256(ENC.encode(pw));
  const approval = await requestApproval(clientHash);
  if (!approval) return;

  const key = await deriveKey(pw, approval);
  const iv = crypto.getRandomValues(new Uint8Array(12));

  const cipher = await crypto.subtle.encrypt(
    { name:"AES-GCM", iv },
    key,
    ENC.encode(plain.value)
  );

  out.textContent = JSON.stringify({
    iv: btoa(String.fromCharCode(...iv)),
    data: btoa(String.fromCharCode(...new Uint8Array(cipher)))
  }, null, 2);
}

/* ================== DECRYPT ================== */
async function decrypt() {
  const pw = pwVal();
  if (!pw) return msg("âŒ Passwort fehlt");

  let obj;
  try { obj = JSON.parse(out.textContent); }
  catch { return msg("âŒ UngÃ¼ltige Daten"); }

  const clientHash = await sha256(ENC.encode(pw));
  const approval = await requestApproval(clientHash);
  if (!approval) return;

  const key = await deriveKey(pw, approval);

  try {
    const plainText = await crypto.subtle.decrypt(
      { name:"AES-GCM", iv: Uint8Array.from(atob(obj.iv),c=>c.charCodeAt(0)) },
      key,
      Uint8Array.from(atob(obj.data),c=>c.charCodeAt(0))
    );
    msg("âœ… EntschlÃ¼sselt:\n" + DEC.decode(plainText));
  } catch {
    msg("âŒ Falsches Passwort / Faktoren");
  }
}

/* ================== SERVER ================== */
async function requestApproval(clientHash) {
  try {
    const r = await fetch(SERVER, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ clientHash })
    });
    const j = await r.json();
    return j.ok ? j.approval : null;
  } catch {
    msg("âŒ Server nicht erreichbar");
    return null;
  }
}

/* ================== HELPERS ================== */
function pwVal() {
  return pw.value + f1.value + f2.value + f3.value;
}
function msg(t){ out.textContent = t; }
</script>

</body>
</html>
