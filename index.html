<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mini Messenger Dark</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  body, html {
    margin:0;
    padding:0;
    height:100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color:#121c21;
    color:#e5ddd5;
    display:flex;
    justify-content:center;
    align-items:center;
  }

  .container {
    width:90%;
    max-width:400px;
    background-color:#1e2c2b;
    border-radius:10px;
    padding:20px;
    box-sizing:border-box;
    box-shadow:0 4px 10px rgba(0,0,0,0.5);
    text-align:center;
    display:flex;
    flex-direction:column;
    height:80%;
  }

  h1 { color:#25d366; margin-bottom:20px; }
  input, #message {
    width:100%;
    padding:12px;
    margin:10px 0;
    border-radius:8px;
    border:none;
    background-color:#2a3b3a;
    color:#e5ddd5;
    font-size:16px;
  }

  input::placeholder, #message::placeholder { color:#b0baba; }
  button {
    width:100%;
    padding:12px;
    margin-top:10px;
    border:none;
    border-radius:8px;
    background-color:#25d366;
    color:#fff;
    font-size:16px;
    cursor:pointer;
    transition:0.3s;
  }

  button:hover { background-color:#128c7e; }
  #chat { flex:1; overflow-y:auto; padding:10px; border-radius:8px; background-color:#1b2a29; margin-top:10px; }
  .message { padding:6px 10px; margin:5px 0; border-radius:10px; max-width:80%; word-wrap:break-word; }
  .sent { background-color:#25d366; color:#fff; align-self:flex-end; }
  .received { background-color:#2a3b3a; color:#e5ddd5; align-self:flex-start; }
  .system { text-align:center; font-style:italic; color:#b0baba; }
</style>
</head>
<body>

<div class="container" id="loginContainer">
  <h1>Mini Messenger</h1>
  <input type="text" id="userIdInput" placeholder="Deine User-ID">
  <input type="text" id="targetIdInput" placeholder="EmpfÃ¤nger User-ID">
  <button id="loginBtn">Login & Chat starten</button>
  <div class="system" id="loginFeedback"></div>
</div>

<div class="container" id="chatContainer" style="display:none;">
  <h1 id="chatHeader"></h1>
  <div id="chat"></div>
  <input type="text" id="message" placeholder="Nachricht eingeben...">
  <button id="sendBtn">Senden</button>
</div>

<script>
const SERVER_URL = 'wss://unwintry-strapping-winford.ngrok-free.dev';
let ws;
let userId = '';
let targetId = '';
const SECRET_KEY = "supergeheimeschluessel"; // AES Demo

const loginContainer = document.getElementById('loginContainer');
const chatContainer = document.getElementById('chatContainer');
const chatDiv = document.getElementById('chat');
const chatHeader = document.getElementById('chatHeader');
const loginFeedback = document.getElementById('loginFeedback');

function logMessage(text, type='system'){
  const div = document.createElement('div');
  div.textContent = text;
  div.className = 'message ' + type;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

document.getElementById('loginBtn').onclick = () => {
  const uId = document.getElementById('userIdInput').value.trim();
  const tId = document.getElementById('targetIdInput').value.trim();
  if(!uId || !tId){
    loginFeedback.textContent = "Bitte beide User-IDs eingeben!";
    return;
  }

  userId = uId;
  targetId = tId;

  // Verbindung zum Server
  ws = new WebSocket(SERVER_URL);
  ws.onopen = () => {
    ws.send(JSON.stringify({type:'register', userId}));
    loginContainer.style.display='none';
    chatContainer.style.display='flex';
    chatHeader.textContent = "Chat mit: " + targetId;
    logMessage("Verbunden mit Server", 'system');
  };
  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    if(data.from && data.text){
      if(data.from !== targetId) return; // nur Nachrichten vom Ziel anzeigen
      const decrypted = CryptoJS.AES.decrypt(data.text, SECRET_KEY).toString(CryptoJS.enc.Utf8);
      logMessage(data.from + ": " + decrypted, 'received');
    }
  };
  ws.onclose = () => logMessage("Verbindung geschlossen", 'system');
};

document.getElementById('sendBtn').onclick = () => {
  const text = document.getElementById('message').value.trim();
  if(!text || !ws || ws.readyState!==WebSocket.OPEN) return;
  const encrypted = CryptoJS.AES.encrypt(text, SECRET_KEY).toString();
  ws.send(JSON.stringify({type:'message', to:targetId, text:encrypted}));
  logMessage("Du: " + text, 'sent');
  document.getElementById('message').value='';
};
</script>

</body>
</html>
