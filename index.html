<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto-Gate Client</title>
<style>
  body { font-family: Arial, sans-serif; background: #0e0e2c; color: #e0e0ff; padding: 2rem; }
  h1 { color: #88f; }
  input, textarea, button { display: block; width: 100%; margin: 0.5rem 0; padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: none; }
  textarea { height: 100px; resize: vertical; }
  button { background: #4488ff; color: white; cursor: pointer; }
  button:hover { background: #3366cc; }
  .output { background: #111144; padding: 1rem; border-radius: 6px; word-break: break-all; }
</style>
</head>
<body>
<h1>Crypto-Gate Client</h1>

<label>Passwort:</label>
<input type="password" id="password" placeholder="Passwort eingeben">

<label>Klartext / zu verschlüsselnde Nachricht:</label>
<textarea id="plaintext"></textarea>

<label>Verschlüsselter String:</label>
<textarea id="ciphertext" readonly></textarea>

<button id="encryptBtn">Encrypt</button>
<button id="decryptBtn">Decrypt</button>

<script>
const SERVER = 'https://unwintry-strapping-winford.ngrok-free.dev'; // Server-Adresse

let currentChallenge = '';

async function getChallenge() {
  try {
    const res = await fetch(`${SERVER}/api/challenge`, { method: 'POST' });
    const data = await res.json();
    if (data.challenge) {
      currentChallenge = data.challenge;
      console.log('Challenge erhalten:', currentChallenge);
    } else {
      alert('Fehler beim Abrufen der Challenge: ' + JSON.stringify(data));
    }
  } catch(err) {
    alert('Challenge Fehler: ' + err);
  }
}

// HMAC für Signatur
async function hmacSHA256(data, key) {
  const enc = new TextEncoder();
  const cryptoKey = await crypto.subtle.importKey(
    'raw', enc.encode(key), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
  );
  const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(data));
  return Array.from(new Uint8Array(sig)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// Zufalls-Nonce
function randomNonce(length=16){
  const arr = new Uint8Array(length);
  crypto.getRandomValues(arr);
  return Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function sendCrypto(mode){
  if(!currentChallenge) await getChallenge();
  const password = document.getElementById('password').value;
  const data = mode==='encrypt' ? document.getElementById('plaintext').value : document.getElementById('ciphertext').value;
  const nonce = randomNonce();

  const payloadHash = await hmacSHA256(JSON.stringify({ challenge: currentChallenge, nonce, mode }), 'SIGNING_PLACEHOLDER');
  
  try {
    const res = await fetch(`${SERVER}/api/${mode}`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        challenge: currentChallenge,
        nonce,
        password,
        data,
        signature: payloadHash
      })
    });
    const json = await res.json();
    if(json.result){
      if(mode==='encrypt') document.getElementById('ciphertext').value = json.result;
      if(mode==='decrypt') document.getElementById('plaintext').value = json.result;
    } else if(json.error){
      alert('Server Fehler: ' + json.error);
    }
  } catch(err){
    alert('Request Fehler: ' + err);
  }

  // Neue Challenge nach jeder Aktion
  await getChallenge();
}

document.getElementById('encryptBtn').addEventListener('click', ()=>sendCrypto('encrypt'));
document.getElementById('decryptBtn').addEventListener('click', ()=>sendCrypto('decrypt'));

// Challenge direkt beim Laden holen
getChallenge();
</script>
</body>
</html>
