<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Server-gebundene Verschlüsselung</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
    font-family: 'Fira Code', monospace;
    background-color: #0a0a0a;
    color: #00ff00;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 2rem;
}
.container {
    width: 100%;
    max-width: 600px;
    background-color: #111111;
    border: 2px solid #00ff00;
    border-radius: 8px;
    padding: 2rem;
    box-shadow: 0 0 20px #00ff00aa;
    animation: fadeIn 1s ease;
}
@keyframes fadeIn {
    from {opacity:0; transform: translateY(-20px);}
    to {opacity:1; transform: translateY(0);}
}
input, button, textarea {
    background-color: #0a0a0a;
    color: #00ff00;
    border: 1px solid #00ff00;
    padding: 0.5rem;
    margin-bottom: 1rem;
    width: 100%;
    border-radius: 4px;
    font-family: 'Fira Code', monospace;
}
button {
    cursor: pointer;
    transition: all 0.2s;
}
button:hover {
    background-color: #00ff00;
    color: #0a0a0a;
    box-shadow: 0 0 10px #00ff00;
}
#out {
    background-color: #0a0a0a;
    border: 1px dashed #00ff00;
    padding: 1rem;
    min-height: 6rem;
    word-break: break-all;
    white-space: pre-wrap;
}
</style>
</head>
<body>
<div class="container">
<h1 class="text-2xl font-bold mb-4">Server-gebundene Verschlüsselung</h1>

<label>Passwort (Pflicht)</label>
<input type="password" id="password" placeholder="Passwort eingeben">

<label>Sicherheitsfaktor 1 (optional)</label>
<input type="password" id="factor1" placeholder="Sekundär-Faktor 1">

<label>Sicherheitsfaktor 2 (optional)</label>
<input type="password" id="factor2" placeholder="Sekundär-Faktor 2">

<label>Sicherheitsfaktor 3 (optional)</label>
<input type="password" id="factor3" placeholder="Sekundär-Faktor 3">

<button onclick="encrypt()">Verschlüsseln</button>

<pre id="out">Warten auf Eingabe...</pre>
</div>

<script>
const API = "https://unwintry-strapping-winford.ngrok-free.dev/api/encryption-approval"; 
const TOKEN = "9f3c8a1d4e2b7a6c8f1e9d0a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b";

async function sha256(str) {
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2,"0")).join("");
}

async function requestServerApproval(clientSecret) {
    try {
        const res = await fetch(API, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-API-Token": TOKEN
            },
            body: JSON.stringify({ clientHash: clientSecret })
        });

        if (!res.ok) throw new Error(`Server antwortete mit Status ${res.status}`);
        const data = await res.json();
        if (!data.approved || !data.secretComponent) throw new Error("Server verweigerte Freigabe oder kein Secret");
        return data.secretComponent;
    } catch (err) {
        console.error("Fehler beim API-Aufruf:", err);
        throw err;
    }
}

async function encrypt() {
    const password = document.getElementById("password").value;
    if (!password) {
        alert("Passwort ist Pflicht!");
        return;
    }
    const factors = [
        document.getElementById("factor1").value,
        document.getElementById("factor2").value,
        document.getElementById("factor3").value
    ];
    const combined = password + factors.join("|");
    const clientHash = await sha256(combined);

    try {
        const serverPart = await requestServerApproval(clientHash);
        const finalKey = await sha256(clientHash + serverPart);

        document.getElementById("out").textContent =
`Client-Hash: ${clientHash}
Server-Part: ${serverPart}
Final-Key: ${finalKey}`;
    } catch (err) {
        document.getElementById("out").textContent = "Fehler: " + err.message;
    }
}
</script>
</body>
</html>
