<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CyberSecure Encryptor</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  background: #0f0f0f;
  color: #ff4d4d;
  font-family: 'Fira Code', monospace;
  display: flex;
  justify-content: center;
  padding: 2rem;
}
.container {
  max-width: 600px;
  width: 100%;
  background: linear-gradient(145deg, #1a1a1a, #111111);
  border: 2px solid #ff4d4d;
  border-radius: 15px;
  padding: 2rem;
  box-shadow: 0 0 20px #ff4d4d50, 0 0 40px #ff0000;
}
h1 {
  text-align: center;
  font-size: 2rem;
  margin-bottom: 1.5rem;
  color: #ff6b6b;
}
input, textarea {
  width: 100%;
  background: #1a1a1a;
  color: #ff9999;
  border: 1px solid #ff4d4d;
  border-radius: 8px;
  padding: 0.6rem;
  margin-bottom: 1rem;
  transition: 0.2s;
}
input:focus, textarea:focus {
  border-color: #ff9999;
  box-shadow: 0 0 8px #ff4d4d50;
  outline: none;
}
button {
  width: 48%;
  padding: 0.6rem;
  background: #ff4d4d;
  color: #0f0f0f;
  font-weight: bold;
  border-radius: 8px;
  margin-right: 2%;
  transition: 0.2s;
  cursor: pointer;
}
button:hover {
  background: #ff6b6b;
  box-shadow: 0 0 12px #ff4d4d80;
}
.output {
  background: #1a1a1a;
  color: #ff9999;
  padding: 1rem;
  border: 1px dashed #ff4d4d;
  border-radius: 8px;
  white-space: pre-wrap;
  word-break: break-word;
  margin-top: 1rem;
  position: relative;
  transition: 0.2s;
}
.output:hover {
  box-shadow: 0 0 15px #ff4d4d60;
}
.copy-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  background: #ff4d4d;
  color: #0f0f0f;
  border: none;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
  transition: 0.2s;
}
.copy-btn:hover { background: #ff6b6b; }
</style>
</head>
<body>
<div class="container">
<h1>CyberSecure Encryptor</h1>

<label>Text:</label>
<textarea id="plaintext" rows="4" placeholder="Hier Text eingeben..."></textarea>

<label>Hauptpasswort:</label>
<input type="password" id="mainpass" placeholder="Pflichtfeld">

<label>ZusatzpasswÃ¶rter (optional, 3 max):</label>
<input type="password" id="addon1" placeholder="Optional 1">
<input type="password" id="addon2" placeholder="Optional 2">
<input type="password" id="addon3" placeholder="Optional 3">

<div class="flex justify-between">
<button onclick="encryptData()">ðŸ”’ VerschlÃ¼sseln</button>
<button onclick="decryptData()">ðŸ”“ EntschlÃ¼sseln</button>
</div>

<div class="output" id="output">
  <button class="copy-btn" onclick="copyOutput()">Kopieren</button>
  <div id="outputText">---</div>
</div>
</div>

<script>
const SERVER_URL = "https://unwintry-strapping-winford.ngrok-free.dev/api/approve";
const SERVER_TOKEN = "ReplaceWithYourServerSecretToken";

async function getServerApproval(clientHash) {
  try {
    const res = await fetch(SERVER_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-Token": SERVER_TOKEN
      },
      body: JSON.stringify({ clientHash })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.message || 'Server verweigert');
    return data.approval;
  } catch (err) {
    alert("Server Error: " + err.message);
    throw err;
  }
}

async function deriveKey(password, addons) {
  const combined = password + addons.join("|");
  const enc = new TextEncoder().encode(combined);
  const keyMaterial = await crypto.subtle.importKey("raw", enc, {name:"PBKDF2"}, false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2", salt: enc, iterations: 1000000, hash:"SHA-256"},
    keyMaterial,
    {name:"AES-GCM", length:256},
    true,
    ["encrypt","decrypt"]
  );
}

async function encryptData() {
  const text = document.getElementById("plaintext").value;
  const main = document.getElementById("mainpass").value;
  const addons = [
    document.getElementById("addon1").value,
    document.getElementById("addon2").value,
    document.getElementById("addon3").value
  ].filter(a=>a!=="");

  if(!text || !main) { alert("Text + Hauptpasswort nÃ¶tig!"); return; }

  const key = await deriveKey(main, addons);
  const enc = new TextEncoder().encode(text);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ciphertext = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, enc);
  const combined = ivToBase64(iv) + ":" + arrayBufferToBase64(ciphertext);

  const clientHash = await sha256(main + combined);
  const serverApproval = await getServerApproval(clientHash);
  document.getElementById("outputText").textContent = combined;
}

async function decryptData() {
  const combined = document.getElementById("plaintext").value;
  const main = document.getElementById("mainpass").value;
  const addons = [
    document.getElementById("addon1").value,
    document.getElementById("addon2").value,
    document.getElementById("addon3").value
  ].filter(a=>a!=="");

  if(!combined || !main) { alert("Ciphertext + Hauptpasswort nÃ¶tig!"); return; }

  const [ivStr, dataStr] = combined.split(":");
  if(!ivStr || !dataStr) { alert("UngÃ¼ltiges Format"); return; }

  const key = await deriveKey(main, addons);
  const iv = base64ToArrayBuffer(ivStr);
  const data = base64ToArrayBuffer(dataStr);
  try {
    const decrypted = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, data);
    const decText = new TextDecoder().decode(decrypted);
    document.getElementById("outputText").textContent = decText;
  } catch(e) {
    alert("EntschlÃ¼sselung fehlgeschlagen (Serverfreigabe benÃ¶tigt oder falsches Passwort)");
  }
}

function arrayBufferToBase64(buf) {
  let binary = '';
  const bytes = new Uint8Array(buf);
  bytes.forEach(b=>binary += String.fromCharCode(b));
  return btoa(binary);
}
function base64ToArrayBuffer(base64) {
  const binary = atob(base64);
  const buf = new Uint8Array(binary.length);
  for(let i=0;i<binary.length;i++) buf[i] = binary.charCodeAt(i);
  return buf.buffer;
}
function ivToBase64(iv) { return arrayBufferToBase64(iv); }
async function sha256(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,"0")).join("");
}
function copyOutput() {
  const el = document.getElementById("outputText");
  navigator.clipboard.writeText(el.textContent).then(()=>alert("Kopiert!"));
}
</script>
</body>
</html>
