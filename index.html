<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cyber-Crypto Tool</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #0d0d0d; color: #f0f0f0; display: flex; flex-direction: column; align-items: center; padding: 2rem; }
  h1 { color: #00ffff; }
  input, textarea, button { width: 100%; max-width: 400px; margin: 0.5rem 0; padding: 0.5rem; border-radius: 0.5rem; border: none; font-size: 1rem; }
  textarea { resize: vertical; }
  button { background: #00ffff; color: #000; font-weight: bold; cursor: pointer; }
  .output { background: #111; padding: 1rem; border-radius: 0.5rem; word-break: break-all; }
</style>
</head>
<body>

<h1>Cyber-Crypto Tool</h1>

<label for="password">Passwort:</label>
<input type="password" id="password" placeholder="Passwort eingeben">

<label for="plaintext">Klartext:</label>
<textarea id="plaintext" rows="4" placeholder="Text zum Verschlüsseln"></textarea>

<button id="encryptBtn">Verschlüsseln</button>
<button id="decryptBtn">Entschlüsseln</button>

<h3>Ergebnis:</h3>
<div class="output" id="result"></div>

<script>
const SERVER_URL = 'https://unwintry-strapping-winford.ngrok-free.dev';

async function getChallenge() {
  try {
    const resp = await fetch(`${SERVER_URL}/api/challenge`, { method: 'POST' });
    if (!resp.ok) throw new Error('Challenge konnte nicht abgerufen werden');
    return await resp.json();
  } catch (err) {
    alert('Challenge Fehler: ' + err.message);
    throw err;
  }
}

async function doCrypto(mode) {
  const password = document.getElementById('password').value;
  const data     = document.getElementById('plaintext').value;

  if (!password || !data) {
    alert('Bitte Passwort und Text ausfüllen');
    return;
  }

  try {
    const { challenge } = await getChallenge();
    const nonce = cryptoRandomHex(16);

    const payload = { challenge, nonce, password, data, mode };
    payload.signature = await generateSignature(challenge, nonce, mode);

    const resp = await fetch(`${SERVER_URL}/api/${mode}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!resp.ok) throw new Error('Serverantwort ungültig');
    const resultData = await resp.json();
    document.getElementById('result').textContent = resultData.result;

  } catch (err) {
    document.getElementById('result').textContent = 'Fehler: ' + err.message;
  }
}

// --- Hilfsfunktionen ---
function cryptoRandomHex(length) {
  const array = new Uint8Array(length);
  crypto.getRandomValues(array);
  return Array.from(array, b => b.toString(16).padStart(2,'0')).join('');
}

async function generateSignature(challenge, nonce, mode) {
  // Dummy: Signature wird serverseitig geprüft, hier nur placeholder
  return cryptoRandomHex(32);
}

// Event-Handler
document.getElementById('encryptBtn').addEventListener('click', () => doCrypto('encrypt'));
document.getElementById('decryptBtn').addEventListener('click', () => doCrypto('decrypt'));
</script>

</body>
</html>
