<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Secure Encrypt Gateway</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
    background:#0b0f14;
    color:#00ff88;
    font-family: monospace;
    display:flex;
    justify-content:center;
    padding:40px;
}
.box {
    width:100%;
    max-width:700px;
    background:#111827;
    border:1px solid #00ff88;
    padding:20px;
    border-radius:8px;
}
textarea,input {
    width:100%;
    background:#020617;
    color:#00ff88;
    border:1px solid #00ff88;
    padding:10px;
    margin:8px 0;
}
button {
    background:#00ff88;
    color:#000;
    border:none;
    padding:12px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
}
.output {
    background:#020617;
    padding:10px;
    margin-top:10px;
    word-break:break-all;
}
.copy {
    margin-top:5px;
    font-size:12px;
    cursor:pointer;
}
</style>
</head>

<body>
<div class="box">
<h2>ðŸ”’ Secure Encrypt Gateway</h2>

<input id="password" type="password" placeholder="Pflichtâ€‘Passwort (min 12 Zeichen)">
<input id="extra1" type="password" placeholder="Zusatz 1 (optional)">
<input id="extra2" type="password" placeholder="Zusatz 2 (optional)">
<input id="extra3" type="password" placeholder="Zusatz 3 (optional)">

<textarea id="input" rows="4" placeholder="Text zum VerschlÃ¼sseln / EntschlÃ¼sseln"></textarea>

<button onclick="encrypt()">VERSCHLÃœSSELN</button>
<button onclick="decrypt()">ENTSCHLÃœSSELN</button>

<div class="output" id="output">---</div>
<div class="copy" onclick="copy()">ðŸ“‹ kopieren</div>
</div>

<script>
const SERVER_URL = "https://unwintry-strapping-winford.ngrok-free.dev/api/approve";
const ITERATIONS = 1_000_000;
const encoder = new TextEncoder();
const decoder = new TextDecoder();

function b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)))}
function fromB64(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0))}

async function deriveKey(pass, salt) {
    return crypto.subtle.deriveKey(
        { name:"PBKDF2", salt, iterations:ITERATIONS, hash:"SHA-256" },
        await crypto.subtle.importKey("raw", encoder.encode(pass), "PBKDF2", false, ["deriveKey"]),
        { name:"AES-GCM", length:256 },
        false,
        ["encrypt","decrypt"]
    );
}

async function serverApprove(clientHash){
    const res = await fetch(SERVER_URL,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ clientHash })
    });
    if(!res.ok) throw "Server error";
    return (await res.json()).approval;
}

async function encrypt(){
    try{
        const pw = password.value;
        if(pw.length < 12) return alert("Passwort zu kurz");

        const fullPass = pw + extra1.value + extra2.value + extra3.value;
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));

        const hash = await crypto.subtle.digest("SHA-256", encoder.encode(fullPass));
        const serverPart = await serverApprove(b64(hash));

        const key = await deriveKey(fullPass + serverPart, salt);
        const cipher = await crypto.subtle.encrypt(
            { name:"AES-GCM", iv },
            key,
            encoder.encode(input.value)
        );

        output.textContent =
            b64(salt) + "." + b64(iv) + "." + b64(cipher);

    }catch(e){
        output.textContent = "âŒ Fehler";
    }
}

async function decrypt(){
    try{
        const pw = password.value;
        const fullPass = pw + extra1.value + extra2.value + extra3.value;
        const [s,i,d] = input.value.split(".");

        const salt = fromB64(s);
        const iv = fromB64(i);
        const data = fromB64(d);

        const hash = await crypto.subtle.digest("SHA-256", encoder.encode(fullPass));
        const serverPart = await serverApprove(b64(hash));

        const key = await deriveKey(fullPass + serverPart, salt);
        const plain = await crypto.subtle.decrypt(
            { name:"AES-GCM", iv },
            key,
            data
        );

        output.textContent = decoder.decode(plain);
    }catch(e){
        output.textContent = "âŒ EntschlÃ¼sselung fehlgeschlagen";
    }
}

function copy(){
    navigator.clipboard.writeText(output.textContent);
}
</script>
</body>
</html>
