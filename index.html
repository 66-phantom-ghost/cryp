<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Erweiterte Server-VerschlÃ¼sselung</title>

<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
</style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="w-full max-w-lg bg-gray-800 p-6 rounded-xl shadow-xl border border-gray-700">

<h1 class="text-2xl font-bold text-green-400 mb-4">
ğŸ” Mehrstufige VerschlÃ¼sselung
</h1>

<input id="msg" placeholder="Text"
class="w-full p-2 mb-3 bg-gray-700 rounded border border-gray-600">

<input id="password" type="password" placeholder="Pflicht-Passwort"
class="w-full p-2 mb-3 bg-gray-700 rounded border border-gray-600">

<input id="extra1" placeholder="Zusatz 1 (optional)"
class="w-full p-2 mb-2 bg-gray-700 rounded border border-gray-600">

<input id="extra2" placeholder="Zusatz 2 (optional)"
class="w-full p-2 mb-2 bg-gray-700 rounded border border-gray-600">

<input id="extra3" placeholder="Zusatz 3 (optional)"
class="w-full p-2 mb-4 bg-gray-700 rounded border border-gray-600">

<button onclick="encrypt()"
class="w-full bg-green-600 hover:bg-green-700 p-3 rounded font-semibold">
VerschlÃ¼sseln (Server-Freigabe)
</button>

<pre id="out" class="mt-4 p-4 bg-gray-700 rounded text-sm h-48 overflow-auto">
Wartenâ€¦
</pre>

</div>

<script>
const API = "https://unwintry-strapping-winford.ngrok-free.dev/api/approve";
const TOKEN = "d9F3kL1bQ7rXp2VwZ8nM5tC4sJ6yH0uR";

async function sha256(str) {
  const buf = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(str)
  );
  return [...new Uint8Array(buf)]
    .map(b => b.toString(16).padStart(2,"0"))
    .join("");
}

async function encrypt() {
  const msg = msg.value;
  const pwd = password.value;
  const e1 = extra1.value || "";
  const e2 = extra2.value || "";
  const e3 = extra3.value || "";
  const out = document.getElementById("out");

  if (!msg || !pwd) {
    out.textContent = "âŒ Text und Passwort sind Pflicht.";
    return;
  }

  out.textContent = "â³ Server wird kontaktiertâ€¦";

  // ğŸ”‘ Client-Basis (Passwort ist Pflicht!)
  const baseMaterial = msg + "|" + pwd + "|" + e1 + "|" + e2 + "|" + e3;
  const clientHash = await sha256(baseMaterial);

  try {
    const res = await fetch(API, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-API-Token": TOKEN
      },
      body: JSON.stringify({ clientHash })
    });

    const data = await res.json();
    if (!res.ok || !data.ok) {
      out.textContent = "âŒ Server hat abgelehnt.";
      return;
    }

    // ğŸ”’ Server-Approval
    const approval = data.approval;

    // ğŸ” Finaler Key (ohne Server + Passwort unmÃ¶glich)
    const finalKey = await sha256(clientHash + approval);

    out.textContent =
      "âœ… VerschlÃ¼sselung erlaubt\n" +
      "---------------------------------\n" +
      "Pflicht-Passwort: âœ”ï¸\n" +
      "Zusatz 1: " + (e1 ? "âœ”ï¸" : "â€”") + "\n" +
      "Zusatz 2: " + (e2 ? "âœ”ï¸" : "â€”") + "\n" +
      "Zusatz 3: " + (e3 ? "âœ”ï¸" : "â€”") + "\n" +
      "---------------------------------\n" +
      "Finaler Key:\n" +
      finalKey.slice(0, 64) + "â€¦\n\n" +
      "ğŸ”’ Ohne exakt diese Daten + Server\n" +
      "ist EntschlÃ¼sselung unmÃ¶glich.";

  } catch {
    out.textContent = "âŒ Server nicht erreichbar.";
  }
}
</script>

</body>
</html>
