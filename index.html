<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShadowFX | Sicherer Messenger</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
:root {
  --bg-dark: #050505;
  --panel-dark: #121212;
  --accent: #10b981;
}
body { margin:0; font-family:'Inter', sans-serif; background-color:var(--bg-dark); color:#e5e7eb; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
.message-in { border-bottom-left-radius: 2px; }
.message-out { border-bottom-right-radius: 2px; }
</style>
</head>
<body class="h-screen flex flex-col">

<!-- Setup Screen -->
<div id="setup-screen" class="fixed inset-0 flex items-center justify-center bg-[#050505] p-6">
  <div class="w-full max-w-sm text-center">
    <h1 class="text-3xl font-bold mb-4">ShadowFX</h1>
    <p class="text-zinc-500 mb-6">Dezentral & verschlüsselt</p>
    <input type="text" id="username" placeholder="Name wählen" class="w-full mb-4 p-4 rounded-xl bg-zinc-900 border border-zinc-800 text-white">
    <button id="create-account" class="w-full py-4 bg-emerald-600 rounded-xl font-bold hover:bg-emerald-500 transition-all">Account erstellen</button>
  </div>
</div>

<!-- App Screen -->
<div id="app" class="hidden flex-1 flex overflow-hidden">
  <!-- Sidebar -->
  <div class="w-80 border-r border-zinc-900 flex flex-col bg-[#080808]">
    <div class="p-4 flex justify-between items-center">
      <h2 class="font-bold text-lg">Chats</h2>
      <button onclick="openAddContact()" class="bg-emerald-600 p-2 rounded-xl hover:bg-emerald-500">+</button>
    </div>
    <div id="contact-list" class="flex-1 overflow-y-auto custom-scrollbar p-2"></div>
    <div class="p-4 border-t border-zinc-900">
      <div class="flex items-center gap-2">
        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
        <span id="status-text" class="text-[10px] text-zinc-500 font-bold">Getrennt</span>
      </div>
    </div>
  </div>

  <!-- Chat Window -->
  <div class="flex-1 flex flex-col">
    <div id="no-chat" class="flex-1 flex flex-col items-center justify-center text-zinc-600">
      <p>Wähle einen Kontakt</p>
    </div>
    <div id="chat-window" class="hidden flex-1 flex flex-col">
      <div id="chat-header" class="flex items-center gap-4 p-4 border-b border-zinc-900">
        <button onclick="backToList()" class="md:hidden">←</button>
        <div id="chat-name" class="font-bold">Kontakt</div>
        <div id="chat-id" class="text-[10px] text-emerald-500 font-mono">ID: ...</div>
      </div>
      <div id="messages" class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-2"></div>
      <div class="p-4 bg-[#121212] flex gap-2">
        <input type="text" id="msg-input" placeholder="Nachricht..." class="flex-1 p-2 rounded-xl bg-zinc-900 text-white outline-none">
        <button onclick="sendMsg()" class="bg-emerald-600 p-2 rounded-xl hover:bg-emerald-500">Senden</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Contact Modal -->
<div id="add-contact-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black/70">
  <div class="bg-zinc-900 p-6 rounded-xl w-full max-w-sm">
    <h2 class="font-bold text-lg mb-4">Kontakt hinzufügen</h2>
    <input type="text" id="contact-id" placeholder="ID des Kontakts" class="w-full p-3 rounded-xl bg-black mb-4 text-white">
    <input type="text" id="contact-name" placeholder="Name" class="w-full p-3 rounded-xl bg-black mb-6 text-white">
    <div class="flex gap-2">
      <button onclick="closeAddContact()" class="flex-1 bg-zinc-800 py-3 rounded-xl">Abbrechen</button>
      <button onclick="saveContact()" class="flex-1 bg-emerald-600 py-3 rounded-xl">Speichern</button>
    </div>
  </div>
</div>

<script>
let ws, myId, myName, keyPair;
let contacts = JSON.parse(localStorage.getItem('sfx_contacts')||'[]');
let activeContact = null;

// --- Crypto helper ---
async function exportKey(key){const exported=await crypto.subtle.exportKey(key.type==='private'?'pkcs8':'spki',key);return btoa(String.fromCharCode(...new Uint8Array(exported)));}
async function importKey(b64,type){const bin=Uint8Array.from(atob(b64),c=>c.charCodeAt(0));return crypto.subtle.importKey(type==='private'?'pkcs8':'spki',bin,{name:"RSA-OAEP",hash:"SHA-256"},true,type==='private'?["decrypt"]:["encrypt"]);}

// --- Setup / Account ---
document.getElementById('create-account').onclick=async ()=>{
  const name=document.getElementById('username').value.trim();
  if(!name){alert('Name wählen');return;}
  myName=name;
  myId='sfx-'+Math.random().toString(36).substr(2,9);
  keyPair=await crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},true,["encrypt","decrypt"]);
  localStorage.setItem('sfx_uid',myId);
  localStorage.setItem('sfx_name',myName);
  localStorage.setItem('sfx_pub',await exportKey(keyPair.publicKey));
  localStorage.setItem('sfx_priv',await exportKey(keyPair.privateKey));
  document.getElementById('setup-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  document.getElementById('myIdDisplay')?.innerText=myId;
  connectWS();
  renderContacts();
}

// --- Contacts ---
function openAddContact(){document.getElementById('add-contact-modal').classList.remove('hidden');}
function closeAddContact(){document.getElementById('add-contact-modal').classList.add('hidden');}
function saveContact(){
  const id=document.getElementById('contact-id').value.trim();
  const name=document.getElementById('contact-name').value.trim();
  if(!id||!name)return;
  contacts.push({id,name,publicKey:''});
  localStorage.setItem('sfx_contacts',JSON.stringify(contacts));
  renderContacts();
  closeAddContact();
}
function renderContacts(){
  const list=document.getElementById('contact-list');list.innerHTML='';
  contacts.forEach(c=>{
    const div=document.createElement('div');
    div.className='p-3 rounded-xl hover:bg-zinc-800 cursor-pointer';
    div.innerText=c.name;
    div.onclick=()=>selectContact(c);
    list.appendChild(div);
  });
}

// --- Chat ---
function selectContact(c){
  activeContact=c;
  document.getElementById('no-chat').classList.add('hidden');
  document.getElementById('chat-window').classList.remove('hidden');
  document.getElementById('chat-name').innerText=c.name;
  document.getElementById('chat-id').innerText='ID: '+c.id;
  renderMessages();
}
function renderMessages(){
  if(!activeContact)return;
  const container=document.getElementById('messages');
  const chatLog=JSON.parse(localStorage.getItem('chat_'+activeContact.id)||'[]');
  container.innerHTML='';
  chatLog.forEach(m=>{
    const div=document.createElement('div');
    div.className='p-2 rounded-xl max-w-[70%] '+(m.type==='sent'?'bg-emerald-600 self-end':'bg-zinc-800 self-start');
    div.innerText=m.text;
    container.appendChild(div);
  });
  container.scrollTop=container.scrollHeight;
}
async function sendMsg(){
  const input=document.getElementById('msg-input');
  const text=input.value.trim();
  if(!text||!activeContact)return;
  const targetKey=await importKey(activeContact.publicKey||'', 'public').catch(()=>null);
  let encrypted=text;
  if(targetKey){
    const enc= new TextEncoder();
    const buffer=await crypto.subtle.encrypt({name:"RSA-OAEP"},targetKey,enc.encode(text));
    encrypted=btoa(String.fromCharCode(...new Uint8Array(buffer)));
  }
  ws?.send(JSON.stringify({type:'message',to:activeContact.id,text:encrypted,from:myId}));
  saveMessage(activeContact.id,text,'sent');
  renderMessages();
  input.value='';
}
function saveMessage(chatId,text,type){
  const log=JSON.parse(localStorage.getItem('chat_'+chatId)||'[]');
  log.push({text,type,time:Date.now()});
  localStorage.setItem('chat_'+chatId,JSON.stringify(log));
}

// --- WebSocket ---
function connectWS(){
  ws=new WebSocket('wss://unwintry-strapping-winford.ngrok-free.dev');
  ws.onopen=()=>{document.getElementById('status-dot').className='w-2 h-2 rounded-full bg-emerald-500';document.getElementById('status-text').innerText='Bereit';ws.send(JSON.stringify({type:'register',userId:myId}));}
  ws.onclose=()=>{document.getElementById('status-dot').className='w-2 h-2 rounded-full bg-red-500';document.getElementById('status-text').innerText='Getrennt';setTimeout(connectWS,5000);}
  ws.onmessage=async e=>{const msg=JSON.parse(e.data);if(msg.type==='message'){handleIncoming(msg);}}
}
async function handleIncoming(msg){
  const contact=contacts.find(c=>c.id===msg.from);if(!contact)return;
  let text=msg.text;
  try{const buf=Uint8Array.from(atob(msg.text),c=>c.charCodeAt(0)).buffer;text=new TextDecoder().decode(await crypto.subtle.decrypt({name:"RSA-OAEP"},keyPair.privateKey,buf));}catch{}
  saveMessage(msg.from,text,'received');
  if(activeContact?.id===msg.from)renderMessages();
}
function backToList(){activeContact=null;document.getElementById('no-chat').classList.remove('hidden');document.getElementById('chat-window').classList.add('hidden');}
</script>

</body>
</html>
