<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crypto-Gate</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; display: flex; justify-content: center; padding: 50px; }
  .container { width: 100%; max-width: 500px; background: #222; padding: 30px; border-radius: 12px; }
  h1 { text-align: center; color: #ff5555; }
  label { display: block; margin-top: 15px; }
  input, textarea, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: none; background: #333; color: #eee; }
  button { background: #ff5555; cursor: pointer; margin-top: 15px; }
  button:hover { background: #ff2222; }
  #result { height: 100px; resize: none; }
</style>
</head>
<body>
<div class="container">
  <h1>Crypto-Gate</h1>

  <label for="password">Passwort</label>
  <input type="password" id="password" placeholder="Dein Passwort">

  <label for="plaintext">Text</label>
  <textarea id="plaintext" placeholder="Text zum Verschlüsseln / Entschlüsseln"></textarea>

  <button id="encryptBtn">Verschlüsseln</button>
  <button id="decryptBtn">Entschlüsseln</button>

  <label for="result">Ergebnis</label>
  <textarea id="result" readonly placeholder="Hier erscheint das Ergebnis"></textarea>
  <button id="copyBtn">Kopieren</button>
</div>

<script>
const SERVER_URL = 'https://unwintry-strapping-winford.ngrok-free.dev';

function generateNonce() {
  return Array.from(crypto.getRandomValues(new Uint8Array(16)))
              .map(b => b.toString(16).padStart(2,'0')).join('');
}

async function getChallenge() {
  const res = await fetch(`${SERVER_URL}/api/challenge`, { method: 'POST' });
  if (!res.ok) throw new Error(`Challenge fehlgeschlagen (${res.status})`);
  try {
    return (await res.json()).challenge;
  } catch {
    throw new Error('Serverantwort ungültig');
  }
}

async function sendCrypto(mode) {
  const password = document.getElementById('password').value.trim();
  const data     = document.getElementById('plaintext').value.trim();
  if (!password || !data) return alert('Bitte Passwort und Text eingeben');

  const resultField = document.getElementById('result');
  resultField.value = 'Warte auf Server...';

  try {
    const challenge = await getChallenge();
    const nonce = generateNonce();

    // HMAC clientseitig (nur zur Demo, Server prüft ohnehin)
    const payloadHash = new TextEncoder().encode(JSON.stringify({ challenge, nonce, mode }));
    const key = await crypto.subtle.importKey('raw', new TextEncoder().encode(challenge), {name:'HMAC','hash':'SHA-256'}, false, ['sign']);
    const sigBuffer = await crypto.subtle.sign('HMAC', key, payloadHash);
    const signature = Array.from(new Uint8Array(sigBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');

    const res = await fetch(`${SERVER_URL}/api/${mode}`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ challenge, nonce, password, data, signature })
    });

    if (!res.ok) {
      resultField.value = `Server-Fehler: ${res.status}`;
      return;
    }

    const json = await res.json().catch(()=>null);
    if (!json || !json.result) {
      resultField.value = 'Keine Antwort vom Server / ungültiges Format';
      return;
    }

    resultField.value = json.result;
  } catch(e) {
    resultField.value = 'Fehler: ' + e.message;
  }
}

document.getElementById('encryptBtn').addEventListener('click', ()=>sendCrypto('encrypt'));
document.getElementById('decryptBtn').addEventListener('click', ()=>sendCrypto('decrypt'));
document.getElementById('copyBtn').addEventListener('click', ()=>{
  const r = document.getElementById('result');
  r.select();
  document.execCommand('copy');
  alert('Ergebnis kopiert');
});
</script>
</body>
</html>
